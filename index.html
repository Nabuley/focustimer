<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>집중 타이머</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    * {
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        overflow-x: hidden;
        overflow-y: auto;
    }

    .container {
        background: white;
        padding: 30px;
        width: 100%;
        max-width: 420px;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        z-index: 10;
        position: relative;
        margin: 0 auto;
    }

    h1 {
        text-align: center;
        margin: 0 0 20px 0;
        color: #333;
        font-size: 28px;
        font-weight: 600;
    }

    .mode {
        text-align: center;
        font-weight: 600;
        font-size: 16px;
        color: #667eea;
        margin-bottom: 15px;
        padding: 8px 16px;
        background: #f0f4ff;
        border-radius: 20px;
        display: inline-block;
        width: 100%;
    }

    .timer {
        font-size: 56px;
        text-align: center;
        margin: 20px 0 30px 0;
        font-weight: 700;
        color: #333;
        font-variant-numeric: tabular-nums;
        letter-spacing: 2px;
    }

    .button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 20px;
    }

    .button-group.single {
        grid-template-columns: 1fr;
    }

    button {
        padding: 12px 20px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        border-radius: 10px;
        transition: all 0.3s ease;
        color: white;
    }

    #startBtn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    #startBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    #stopBtn {
        background: #ff6b6b;
    }

    #stopBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
    }

    #resetTimeBtn {
        background: #51cf66;
    }

    #resetTimeBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(81, 207, 102, 0.4);
    }

    #resetAllBtn {
        background: #868e96;
    }

    #resetAllBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(134, 142, 150, 0.4);
    }

    button:active {
        transform: translateY(0);
    }

    .controls {
        margin-top: 25px;
        padding-top: 25px;
        border-top: 2px solid #f1f3f5;
    }

    .controls label {
        display: block;
        margin-top: 15px;
        margin-bottom: 6px;
        font-size: 14px;
        font-weight: 600;
        color: #495057;
    }

    input[type="number"], input[type="text"] {
        width: 100%;
        padding: 10px 12px;
        font-size: 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        transition: border-color 0.3s;
    }

    input[type="number"]:focus, input[type="text"]:focus {
        outline: none;
        border-color: #667eea;
    }

    textarea {
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        resize: none;
        font-family: inherit;
        transition: border-color 0.3s;
        height: 70px;
    }

    textarea:focus {
        outline: none;
        border-color: #667eea;
    }

    #submitDistractionBtn {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        margin-top: 10px;
    }

    #submitDistractionBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
    }

    #clearPostItBtn {
        background: #ffa94d;
        margin-top: 8px;
    }

    #clearPostItBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 169, 77, 0.4);
    }

    .stats {
        margin-top: 25px;
        margin-bottom: 10px;
        padding: 15px;
        font-size: 14px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        line-height: 1.8;
    }

    .stats strong {
        color: #495057;
        font-weight: 600;
    }

    .stat-value {
        color: #667eea;
        font-weight: 700;
    }

    /* 타임라인 - 스택형 바 차트 */
    .timeline {
        margin-top: 25px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .timeline h3 {
        margin: 0 0 15px 0;
        font-size: 16px;
        color: #495057;
    }

    .timeline-bar-container {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        height: 40px;
        display: flex;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .timeline-segment {
        height: 100%;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        border-right: 1px solid rgba(255,255,255,0.3);
    }

    .timeline-segment:last-child {
        border-right: none;
    }

    .timeline-segment:hover {
        opacity: 0.8;
        transform: scaleY(1.05);
    }

    .timeline-legend {
        margin-top: 15px;
        max-height: 200px;
        overflow-y: auto;
    }

    .timeline-legend-item {
        display: flex;
        align-items: center;
        padding: 8px;
        margin-bottom: 6px;
        background: white;
        border-radius: 6px;
        font-size: 13px;
    }

    .timeline-legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        margin-right: 10px;
        flex-shrink: 0;
    }

    .timeline-legend-info {
        flex: 1;
        min-width: 0;
    }

    .timeline-legend-subject {
        font-weight: 600;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .timeline-legend-time {
        font-size: 11px;
        color: #868e96;
        margin-top: 2px;
    }

    /* 툴팁 */
    .timeline-tooltip {
        position: absolute;
        bottom: 50px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 100;
    }

    .timeline-segment:hover .timeline-tooltip {
        opacity: 1;
    }

    /* 알림 */
    .notification {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: white;
        padding: 20px 25px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 1000;
        min-width: 300px;
        animation: slideIn 0.4s ease-out;
    }

    .notification.study {
        border-left: 5px solid #667eea;
    }

    .notification.break {
        border-left: 5px solid #51cf66;
    }

    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }

    .notification.hiding {
        animation: slideOut 0.4s ease-out forwards;
    }

    .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .notification-title {
        font-size: 18px;
        font-weight: 700;
        color: #333;
    }

    .notification-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #868e96;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
    }

    .notification-close:hover {
        background: #f1f3f5;
        color: #495057;
    }

    .notification-message {
        font-size: 15px;
        color: #495057;
        line-height: 1.5;
    }

    /* 포스트잇 */
    .post-it {
        position: fixed;
        width: 160px;
        min-height: 100px;
        background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
        padding: 25px 12px 12px 12px;
        font-size: 13px;
        border-radius: 4px;
        box-shadow: 3px 3px 12px rgba(0,0,0,0.15);
        word-break: break-word;
        transform: rotate(var(--rot));
        z-index: 1;
        line-height: 1.5;
        color: #333;
        border-top: 20px solid rgba(255, 193, 7, 0.3);
        cursor: move;
        user-select: none;
    }

    .post-it.dragging {
        opacity: 0.8;
        z-index: 1000;
    }

    .post-it button {
        position: absolute;
        top: 3px;
        right: 3px;
        width: 22px;
        height: 22px;
        padding: 0;
        font-size: 16px;
        line-height: 22px;
        border: none;
        border-radius: 50%;
        background: #ff6b6b;
        color: white;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: bold;
    }

    .post-it button:hover {
        background: #fa5252;
        transform: scale(1.1);
    }

    /* 30일 추세 그래프 */
    .trend-chart {
        margin-top: 25px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .trend-chart h3 {
        margin: 0 0 15px 0;
        font-size: 16px;
        color: #495057;
    }

    .chart-container {
        position: relative;
        height: 200px;
        background: white;
        border-radius: 10px;
        padding: 15px;
    }

    @media (max-width: 480px) {
        body {
            padding: 15px;
        }

        .container {
            padding: 20px;
        }

        h1 {
            font-size: 24px;
        }

        .timer {
            font-size: 48px;
        }

        .notification {
            right: 15px;
            bottom: 15px;
            min-width: 280px;
        }
    }
</style>
</head>
<body>

<div class="container" id="uiContainer">
    <h1>집중 타이머</h1>

    <div class="controls" style="margin-top: 0; padding-top: 0; border-top: none;">
        <label>현재 공부 과목</label>
        <input type="text" id="currentSubject" placeholder="예: 수학, 영어, 과학...">
    </div>

    <div class="mode" id="mode">공부 중</div>
    <div class="timer" id="timer">25:00</div>

    <div class="button-group">
        <button id="startBtn">시작</button>
        <button id="stopBtn">정지</button>
    </div>

    <div class="button-group">
        <button id="resetTimeBtn">시간 초기화</button>
        <button id="resetAllBtn">전체 초기화</button>
    </div>

    <div class="controls">
        <label>공부 시간 (분)</label>
        <input type="number" id="studyTime" value="25" min="1">

        <label>휴식 시간 (분)</label>
        <input type="number" id="breakTime" value="5" min="1">

        <label>글자당 추가 시간 (초)</label>
        <input type="number" id="penaltyPerChar" value="5" min="1">

        <label>딴짓 입력란</label>
        <textarea id="distractionInput" placeholder="딴생각이 나면 여기에 적으세요..."></textarea>

        <div class="button-group single">
            <button id="submitDistractionBtn">제출</button>
        </div>
        <div class="button-group single">
            <button id="clearPostItBtn">포스트잇 전체 제거</button>
        </div>
    </div>

    <div class="stats">
        <strong>통계</strong><br>
        공부 횟수: <span class="stat-value" id="sessionCount">0</span>회<br>
        총 공부 시간: <span class="stat-value" id="totalTime">0:00:00</span>
    </div>

    <div class="timeline">
        <h3>오늘의 타임라인</h3>
        <div class="timeline-bar-container" id="timelineBar"></div>
        <div class="timeline-legend" id="timelineLegend"></div>
    </div>

    <div class="trend-chart">
        <h3>30일 공부 추세</h3>
        <div class="chart-container">
            <canvas id="trendChart"></canvas>
        </div>
    </div>
</div>

<script>
let timerInterval = null;
let remainingSeconds = 0;
let isStudy = true;
let sessionStartTime = null;
let targetEndTime = null;
let pauseStartTime = null;

let sessionCount = Number(localStorage.getItem("sessionCount")) || 0;
let totalStudyTime = Number(localStorage.getItem("totalStudyTime")) || 0;
let timeline = JSON.parse(localStorage.getItem("timeline")) || [];
let subjectColors = JSON.parse(localStorage.getItem("subjectColors")) || {};
let dailyStats = JSON.parse(localStorage.getItem("dailyStats")) || {};

const ui = document.getElementById("uiContainer");
const timerEl = document.getElementById("timer");
const modeEl = document.getElementById("mode");
const distractionInput = document.getElementById("distractionInput");
const currentSubjectInput = document.getElementById("currentSubject");
const timelineBar = document.getElementById("timelineBar");
const timelineLegend = document.getElementById("timelineLegend");

const studyTime = document.getElementById("studyTime");
const breakTime = document.getElementById("breakTime");
const penaltyPerChar = document.getElementById("penaltyPerChar");

document.getElementById("sessionCount").innerText = sessionCount;
document.getElementById("totalTime").innerText = formatTotalTime(totalStudyTime);

// 과목별 색상 팔레트 (빨간색 제외)
const colorPalette = [
    '#667eea', // 보라
    '#f093fb', // 핑크
    '#4facfe', // 하늘
    '#43e97b', // 민트
    '#fa709a', // 연분홍
    '#feca57', // 노랑
    '#48dbfb', // 청록
    '#ff9ff3', // 자주
    '#54a0ff', // 파랑
    '#00d2d3', // 청록2
    '#5f27cd', // 진보라
    '#ff9068', // 주황 (빨간색 대신)
    '#1dd1a1', // 녹색
    '#ee5a6f', // 장미
];

// 총 공부시간 형식 변환 (초 → H:MM:SS)
function formatTotalTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return `${hours}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
}

// 날짜 키 생성 (YYYY-MM-DD)
function getDateKey(date = new Date()) {
    return date.toISOString().split('T')[0];
}

// 일일 통계 업데이트
function updateDailyStats(studySeconds) {
    const today = getDateKey();
    if (!dailyStats[today]) {
        dailyStats[today] = 0;
    }
    dailyStats[today] += studySeconds;
    
    // 30일 이전 데이터 정리
    const keys = Object.keys(dailyStats).sort();
    if (keys.length > 30) {
        const toDelete = keys.slice(0, keys.length - 30);
        toDelete.forEach(key => delete dailyStats[key]);
    }
    
    localStorage.setItem("dailyStats", JSON.stringify(dailyStats));
    updateTrendChart();
}

// 추세 그래프 업데이트
let trendChart = null;
function updateTrendChart() {
    const ctx = document.getElementById('trendChart').getContext('2d');
    
    // 최근 30일 날짜 생성
    const dates = [];
    const data = [];
    const today = new Date();
    
    for (let i = 29; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateKey = getDateKey(date);
        dates.push(dateKey);
        data.push(Math.floor((dailyStats[dateKey] || 0) / 60)); // 분 단위로 변환
    }
    
    if (trendChart) {
        trendChart.destroy();
    }
    
    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates.map(d => {
                const [year, month, day] = d.split('-');
                return `${month}/${day}`;
            }),
            datasets: [{
                label: '공부 시간 (분)',
                data: data,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 5,
                pointBackgroundColor: '#667eea',
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.parsed.y}분`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + '분';
                        }
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
}

// 과목에 색상 할당하는 함수
function getColorForSubject(subject) {
    if (!subject || subject.trim() === '') {
        return '#868e96';
    }
    
    const normalizedSubject = subject.trim();
    
    if (subjectColors[normalizedSubject]) {
        return subjectColors[normalizedSubject];
    }
    
    const usedColors = Object.values(subjectColors);
    let newColor;
    
    for (let color of colorPalette) {
        if (!usedColors.includes(color)) {
            newColor = color;
            break;
        }
    }
    
    if (!newColor) {
        newColor = colorPalette[Math.floor(Math.random() * colorPalette.length)];
    }
    
    subjectColors[normalizedSubject] = newColor;
    localStorage.setItem("subjectColors", JSON.stringify(subjectColors));
    
    return newColor;
}

function showNotification(type) {
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(n => n.remove());

    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    let title, message;
    if (type === 'study') {
        title = '공부 시작!';
        message = '휴식이 끝났습니다. 다시 집중할 시간입니다!';
    } else {
        title = '휴식 시간!';
        message = '수고하셨습니다! 잠시 쉬어가세요.';
    }
    
    notification.innerHTML = `
        <div class="notification-header">
            <div class="notification-title">${title}</div>
            <button class="notification-close">×</button>
        </div>
        <div class="notification-message">${message}</div>
    `;
    
    document.body.appendChild(notification);
    
    const closeBtn = notification.querySelector('.notification-close');
    closeBtn.onclick = () => {
        notification.classList.add('hiding');
        setTimeout(() => notification.remove(), 400);
    };
    
    setTimeout(() => {
        if (notification.parentElement) {
            notification.classList.add('hiding');
            setTimeout(() => notification.remove(), 400);
        }
    }, 5000);
    
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = type === 'study' ? 800 : 600;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch (e) {
        console.log('Audio not supported');
    }
}

function formatTime(date) {
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${hours}:${minutes}`;
}

function formatDuration(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    if (mins > 0) {
        return `${mins}분 ${secs}초`;
    }
    return `${secs}초`;
}

function updateTimeline() {
    timelineBar.innerHTML = '';
    timelineLegend.innerHTML = '';
    
    if (timeline.length === 0) {
        timelineBar.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #868e96; font-size: 13px;">아직 기록이 없습니다</div>';
        return;
    }

    const sortedTimeline = [...timeline].sort((a, b) => a.startTime - b.startTime);
    const totalDuration = sortedTimeline.reduce((sum, item) => sum + item.duration, 0);
    
    sortedTimeline.forEach(item => {
        const segment = document.createElement('div');
        segment.className = 'timeline-segment';
        
        const percentage = (item.duration / totalDuration) * 100;
        segment.style.width = percentage + '%';
        
        let color;
        if (item.type === 'break') {
            color = '#51cf66';
        } else if (item.type === 'pause') {
            color = '#ff6b6b'; // 중단은 빨간색
        } else {
            color = getColorForSubject(item.subject);
        }
        segment.style.backgroundColor = color;
        
        const tooltip = document.createElement('div');
        tooltip.className = 'timeline-tooltip';
        const startDate = new Date(item.startTime);
        const endDate = new Date(item.endTime);
        let label = item.type === 'study' ? (item.subject || '과목 미지정') : 
                    item.type === 'break' ? '휴식' : '중단';
        tooltip.textContent = `${label} (${formatTime(startDate)}-${formatTime(endDate)})`;
        segment.appendChild(tooltip);
        
        timelineBar.appendChild(segment);
    });
    
    [...sortedTimeline].reverse().forEach(item => {
        const legendItem = document.createElement('div');
        legendItem.className = 'timeline-legend-item';
        
        let color;
        if (item.type === 'break') {
            color = '#51cf66';
        } else if (item.type === 'pause') {
            color = '#ff6b6b';
        } else {
            color = getColorForSubject(item.subject);
        }
        
        const startDate = new Date(item.startTime);
        const endDate = new Date(item.endTime);
        let label = item.type === 'study' ? (item.subject || '과목 미지정') : 
                    item.type === 'break' ? '휴식 시간' : '중단됨';
        
        legendItem.innerHTML = `
            <div class="timeline-legend-color" style="background-color: ${color}"></div>
            <div class="timeline-legend-info">
                <div class="timeline-legend-subject">${label}</div>
                <div class="timeline-legend-time">${formatTime(startDate)} - ${formatTime(endDate)} (${formatDuration(item.duration)})</div>
            </div>
        `;
        
        timelineLegend.appendChild(legendItem);
    });
}

function updateTimerDisplay() {
    const min = Math.floor(remainingSeconds / 60);
    const sec = remainingSeconds % 60;
    timerEl.innerText =
        String(min).padStart(2, "0") + ":" + String(sec).padStart(2, "0");
}

function getCurrentModeSeconds() {
    return (isStudy ? Number(studyTime.value) : Number(breakTime.value)) * 60;
}

function addToTimeline(type, subject, duration, startTime, endTime) {
    timeline.push({
        type: type,
        subject: subject,
        duration: duration,
        startTime: startTime,
        endTime: endTime
    });
    localStorage.setItem("timeline", JSON.stringify(timeline));
    updateTimeline();
}

function tick() {
    const now = Date.now();
    
    if (targetEndTime && now >= targetEndTime) {
        remainingSeconds = 0;
        updateTimerDisplay();
        
        const endTime = Date.now();
        const duration = Math.floor((endTime - sessionStartTime) / 1000);
        
        if (isStudy) {
            const subject = currentSubjectInput.value.trim();
            addToTimeline('study', subject, duration, sessionStartTime, endTime);
            
            sessionCount++;
            localStorage.setItem("sessionCount", sessionCount);
            document.getElementById("sessionCount").innerText = sessionCount;
            
            // 일일 통계 업데이트
            updateDailyStats(duration);
        } else {
            addToTimeline('break', '', duration, sessionStartTime, endTime);
        }

        isStudy = !isStudy;
        modeEl.innerText = isStudy ? "공부 중" : "휴식 중";
        
        showNotification(isStudy ? 'study' : 'break');
        
        remainingSeconds = getCurrentModeSeconds();
        sessionStartTime = Date.now();
        targetEndTime = sessionStartTime + (remainingSeconds * 1000);
    } else if (targetEndTime) {
        remainingSeconds = Math.ceil((targetEndTime - now) / 1000);
        updateTimerDisplay();
        
        if (isStudy) {
            totalStudyTime++;
            localStorage.setItem("totalStudyTime", totalStudyTime);
            document.getElementById("totalTime").innerText = formatTotalTime(totalStudyTime);
        }
    }
}

document.getElementById("startBtn").onclick = () => {
    if (timerInterval) return;
    
    // 중단에서 복귀하는 경우 - 중단 시간 기록
    if (pauseStartTime) {
        const pauseEnd = Date.now();
        const pauseDuration = Math.floor((pauseEnd - pauseStartTime) / 1000);
        
        if (pauseDuration > 0) {
            addToTimeline('pause', '', pauseDuration, pauseStartTime, pauseEnd);
        }
        
        pauseStartTime = null;
    }
    
    if (remainingSeconds <= 0) remainingSeconds = getCurrentModeSeconds();

    if (!sessionStartTime) {
        sessionStartTime = Date.now();
    }
    
    targetEndTime = Date.now() + (remainingSeconds * 1000);
    
    timerInterval = setInterval(tick, 1000);
};

document.getElementById("stopBtn").onclick = () => {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
        
        // 진행 중이던 세션 기록 추가
        if (sessionStartTime && targetEndTime) {
            const now = Date.now();
            const sessionDuration = Math.floor((now - sessionStartTime) / 1000);
            
            if (sessionDuration > 0) {
                if (isStudy) {
                    const subject = currentSubjectInput.value.trim();
                    addToTimeline('study', subject, sessionDuration, sessionStartTime, now);
                    
                    // 공부 시간 통계 반영
                    updateDailyStats(sessionDuration);
                } else {
                    addToTimeline('break', '', sessionDuration, sessionStartTime, now);
                }
            }
        }
        
        if (targetEndTime) {
            const now = Date.now();
            remainingSeconds = Math.max(0, Math.ceil((targetEndTime - now) / 1000));
            updateTimerDisplay();
        }
        
        // 중단 시작 시간 기록
        pauseStartTime = Date.now();
        
        targetEndTime = null;
        sessionStartTime = null;
    }
};

document.getElementById("resetTimeBtn").onclick = () => {
    // 중단 중이었다면 중단 시간 기록
    if (pauseStartTime && !timerInterval) {
        const pauseEnd = Date.now();
        const pauseDuration = Math.floor((pauseEnd - pauseStartTime) / 1000);
        
        if (pauseDuration > 0) {
            addToTimeline('pause', '', pauseDuration, pauseStartTime, pauseEnd);
        }
        
        pauseStartTime = null;
    }
    
    remainingSeconds = getCurrentModeSeconds();
    updateTimerDisplay();
    sessionStartTime = null;
    targetEndTime = null;
};

document.getElementById("resetAllBtn").onclick = () => {
    if (confirm('모든 데이터(통계 및 타임라인)가 삭제됩니다. 계속하시겠습니까?')) {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        isStudy = true;
        sessionCount = 0;
        totalStudyTime = 0;
        timeline = [];
        subjectColors = {};
        dailyStats = {};
        sessionStartTime = null;
        targetEndTime = null;
        pauseStartTime = null;
        localStorage.clear();
        document.querySelectorAll(".post-it").forEach(p => p.remove());
        distractionInput.value = "";
        currentSubjectInput.value = "";
        remainingSeconds = getCurrentModeSeconds();
        modeEl.innerText = "공부 중";
        document.getElementById("sessionCount").innerText = 0;
        document.getElementById("totalTime").innerText = formatTotalTime(0);
        updateTimerDisplay();
        updateTimeline();
        updateTrendChart();
    }
};

document.getElementById("submitDistractionBtn").onclick = () => {
    const text = distractionInput.value.trim();
    if (!text) return;

    if (isStudy) {
        const penalty = Number(penaltyPerChar.value);
        const addedSeconds = text.length * penalty;
        remainingSeconds += addedSeconds;
        
        if (targetEndTime) {
            targetEndTime += addedSeconds * 1000;
        }
        
        updateTimerDisplay();
    }

    const rect = ui.getBoundingClientRect();
    const areas = [
        { x: [0, rect.left - 170], y: [0, window.innerHeight - 130] },
        { x: [rect.right + 10, window.innerWidth - 170], y: [0, window.innerHeight - 130] }
    ];
    const area = areas[Math.floor(Math.random() * areas.length)];
    if (area.x[1] <= area.x[0]) return;

    const x = Math.random() * (area.x[1] - area.x[0]) + area.x[0];
    const y = Math.random() * (area.y[1] - area.y[0]) + area.y[0];

    const postIt = document.createElement("div");
    postIt.className = "post-it";
    postIt.style.left = x + "px";
    postIt.style.top = y + "px";
    postIt.style.setProperty("--rot", (Math.random() * 10 - 5) + "deg");

    const closeBtn = document.createElement("button");
    closeBtn.innerText = "×";
    closeBtn.onclick = (e) => {
        e.stopPropagation();
        postIt.remove();
    };

    postIt.appendChild(closeBtn);
    postIt.appendChild(document.createTextNode(text));
    document.body.appendChild(postIt);

    // 포스트잇 드래그 기능
    let isDragging = false;
    let currentX;
    let currentY;
    let initialX;
    let initialY;
    let xOffset = 0;
    let yOffset = 0;

    postIt.addEventListener("mousedown", dragStart);
    postIt.addEventListener("touchstart", dragStart);

    function dragStart(e) {
        if (e.target.tagName === 'BUTTON') return; // 닫기 버튼 클릭 시 드래그 방지
        
        if (e.type === "touchstart") {
            initialX = e.touches[0].clientX - xOffset;
            initialY = e.touches[0].clientY - yOffset;
        } else {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;
        }

        isDragging = true;
        postIt.classList.add('dragging');

        document.addEventListener("mousemove", drag);
        document.addEventListener("touchmove", drag);
        document.addEventListener("mouseup", dragEnd);
        document.addEventListener("touchend", dragEnd);
    }

    function drag(e) {
        if (!isDragging) return;

        e.preventDefault();

        if (e.type === "touchmove") {
            currentX = e.touches[0].clientX - initialX;
            currentY = e.touches[0].clientY - initialY;
        } else {
            currentX = e.clientX - initialX;
            currentY = e.clientY - initialY;
        }

        xOffset = currentX;
        yOffset = currentY;

        const currentLeft = parseFloat(postIt.style.left);
        const currentTop = parseFloat(postIt.style.top);

        postIt.style.left = (currentLeft + currentX - (parseFloat(postIt.dataset.lastX) || 0)) + "px";
        postIt.style.top = (currentTop + currentY - (parseFloat(postIt.dataset.lastY) || 0)) + "px";

        postIt.dataset.lastX = currentX;
        postIt.dataset.lastY = currentY;
    }

    function dragEnd(e) {
        isDragging = false;
        postIt.classList.remove('dragging');
        postIt.dataset.lastX = 0;
        postIt.dataset.lastY = 0;

        document.removeEventListener("mousemove", drag);
        document.removeEventListener("touchmove", drag);
        document.removeEventListener("mouseup", dragEnd);
        document.removeEventListener("touchend", dragEnd);
    }

    distractionInput.value = "";
};

document.getElementById("clearPostItBtn").onclick = () => {
    document.querySelectorAll(".post-it").forEach(p => p.remove());
};

remainingSeconds = getCurrentModeSeconds();
updateTimerDisplay();
updateTimeline();
updateTrendChart();
</script>

</body>
</html>
